import{a as m}from"./chunk-HY2GWXPO.js";import{F as f}from"./chunk-O2RVWQGL.js";import{c as o}from"./chunk-3GYLW4KZ.js";var C=o((ot,D)=>{var B=f();function g(t){Error.call(this,t),this.message=t}B.inherits(g,Error);g.prototype.name="IllegalArgumentError";function d(t){Error.call(this,t),this.message=t}B.inherits(d,Error);d.prototype.name="IllegalStateError";D.exports.IllegalStateError=d;D.exports.IllegalArgumentError=g});var w=o((st,i)=>{var W=f(),R=i.exports=C();function F(t,e,a,n){a=a||"";var V=W.format.apply(this,[a].concat(n)),S=new t(V);throw Error.captureStackTrace(S,e),S}function _(t,e,a){F(R.IllegalArgumentError,t,e,a)}function X(t,e,a){F(R.IllegalStateError,t,e,a)}i.exports.checkArgument=function(t,e){t||_(arguments.callee,e,Array.prototype.slice.call(arguments,2))};i.exports.checkState=function(t,e){t||X(arguments.callee,e,Array.prototype.slice.call(arguments,2))};i.exports.checkIsDef=function(t,e){if(t!==void 0)return t;_(arguments.callee,e||"Expected value to be defined but was undefined.",Array.prototype.slice.call(arguments,2))};i.exports.checkIsDefAndNotNull=function(t,e){if(t!=null)return t;_(arguments.callee,e||'Expected value to be defined and not null but got "'+N(t)+'".',Array.prototype.slice.call(arguments,2))};function N(t){var e=typeof t;if(e=="object")if(t){if(t instanceof Array)return"array"}else return"null";return e}function u(t){return function(e,a){var n=N(e);if(n==t)return e;_(arguments.callee,a||'Expected "'+t+'" but got "'+n+'".',Array.prototype.slice.call(arguments,2))}}i.exports.checkIsString=u("string");i.exports.checkIsArray=u("array");i.exports.checkIsNumber=u("number");i.exports.checkIsBoolean=u("boolean");i.exports.checkIsFunction=u("function");i.exports.checkIsObject=u("object")});var p=o((ct,q)=>{q.exports=w()});var x=o((ft,M)=>{var T=m(),P=p(),Z=f();function h(t){T.EventEmitter.call(this),this.backoffStrategy_=t,this.maxNumberOfRetry_=-1,this.backoffNumber_=0,this.backoffDelay_=0,this.timeoutID_=-1,this.handlers={backoff:this.onBackoff_.bind(this)}}Z.inherits(h,T.EventEmitter);h.prototype.failAfter=function(t){P.checkArgument(t>0,"Expected a maximum number of retry greater than 0 but got %s.",t),this.maxNumberOfRetry_=t};h.prototype.backoff=function(t){P.checkState(this.timeoutID_===-1,"Backoff in progress."),this.backoffNumber_===this.maxNumberOfRetry_?(this.emit("fail",t),this.reset()):(this.backoffDelay_=this.backoffStrategy_.next(),this.timeoutID_=setTimeout(this.handlers.backoff,this.backoffDelay_),this.emit("backoff",this.backoffNumber_,this.backoffDelay_,t))};h.prototype.onBackoff_=function(){this.timeoutID_=-1,this.emit("ready",this.backoffNumber_,this.backoffDelay_),this.backoffNumber_++};h.prototype.reset=function(){this.backoffNumber_=0,this.backoffStrategy_.reset(),clearTimeout(this.timeoutID_),this.timeoutID_=-1};M.exports=h});var A=o((ht,O)=>{var lt=m(),ut=f();function E(t){return t!=null}function l(t){if(t=t||{},E(t.initialDelay)&&t.initialDelay<1)throw new Error("The initial timeout must be greater than 0.");if(E(t.maxDelay)&&t.maxDelay<1)throw new Error("The maximal timeout must be greater than 0.");if(this.initialDelay_=t.initialDelay||100,this.maxDelay_=t.maxDelay||1e4,this.maxDelay_<=this.initialDelay_)throw new Error("The maximal backoff delay must be greater than the initial backoff delay.");if(E(t.randomisationFactor)&&(t.randomisationFactor<0||t.randomisationFactor>1))throw new Error("The randomisation factor must be between 0 and 1.");this.randomisationFactor_=t.randomisationFactor||0}l.prototype.getMaxDelay=function(){return this.maxDelay_};l.prototype.getInitialDelay=function(){return this.initialDelay_};l.prototype.next=function(){var t=this.next_(),e=1+Math.random()*this.randomisationFactor_,a=Math.round(t*e);return a};l.prototype.next_=function(){throw new Error("BackoffStrategy.next_() unimplemented.")};l.prototype.reset=function(){this.reset_()};l.prototype.reset_=function(){throw new Error("BackoffStrategy.reset_() unimplemented.")};O.exports=l});var G=o((yt,U)=>{var $=f(),tt=p(),L=A();function y(t){L.call(this,t),this.backoffDelay_=0,this.nextBackoffDelay_=this.getInitialDelay(),this.factor_=y.DEFAULT_FACTOR,t&&t.factor!==void 0&&(tt.checkArgument(t.factor>1,"Exponential factor should be greater than 1 but got %s.",t.factor),this.factor_=t.factor)}$.inherits(y,L);y.DEFAULT_FACTOR=2;y.prototype.next_=function(){return this.backoffDelay_=Math.min(this.nextBackoffDelay_,this.getMaxDelay()),this.nextBackoffDelay_=this.backoffDelay_*this.factor_,this.backoffDelay_};y.prototype.reset_=function(){this.backoffDelay_=0,this.nextBackoffDelay_=this.getInitialDelay()};U.exports=y});var v=o((_t,Y)=>{var et=f(),j=A();function k(t){j.call(this,t),this.backoffDelay_=0,this.nextBackoffDelay_=this.getInitialDelay()}et.inherits(k,j);k.prototype.next_=function(){var t=Math.min(this.nextBackoffDelay_,this.getMaxDelay());return this.nextBackoffDelay_+=this.backoffDelay_,this.backoffDelay_=t,t};k.prototype.reset_=function(){this.nextBackoffDelay_=this.getInitialDelay(),this.backoffDelay_=0};Y.exports=k});var H=o((pt,z)=>{var b=m(),s=p(),rt=f(),at=x(),it=v();function r(t,e,a){b.EventEmitter.call(this),s.checkIsFunction(t,"Expected fn to be a function."),s.checkIsArray(e,"Expected args to be an array."),s.checkIsFunction(a,"Expected callback to be a function."),this.function_=t,this.arguments_=e,this.callback_=a,this.lastResult_=[],this.numRetries_=0,this.backoff_=null,this.strategy_=null,this.failAfter_=-1,this.retryPredicate_=r.DEFAULT_RETRY_PREDICATE_,this.state_=r.State_.PENDING}rt.inherits(r,b.EventEmitter);r.State_={PENDING:0,RUNNING:1,COMPLETED:2,ABORTED:3};r.DEFAULT_RETRY_PREDICATE_=function(t){return!0};r.prototype.isPending=function(){return this.state_==r.State_.PENDING};r.prototype.isRunning=function(){return this.state_==r.State_.RUNNING};r.prototype.isCompleted=function(){return this.state_==r.State_.COMPLETED};r.prototype.isAborted=function(){return this.state_==r.State_.ABORTED};r.prototype.setStrategy=function(t){return s.checkState(this.isPending(),"FunctionCall in progress."),this.strategy_=t,this};r.prototype.retryIf=function(t){return s.checkState(this.isPending(),"FunctionCall in progress."),this.retryPredicate_=t,this};r.prototype.getLastResult=function(){return this.lastResult_.concat()};r.prototype.getNumRetries=function(){return this.numRetries_};r.prototype.failAfter=function(t){return s.checkState(this.isPending(),"FunctionCall in progress."),this.failAfter_=t,this};r.prototype.abort=function(){this.isCompleted()||this.isAborted()||(this.isRunning()&&this.backoff_.reset(),this.state_=r.State_.ABORTED,this.lastResult_=[new Error("Backoff aborted.")],this.emit("abort"),this.doCallback_())};r.prototype.start=function(t){s.checkState(!this.isAborted(),"FunctionCall is aborted."),s.checkState(this.isPending(),"FunctionCall already started.");var e=this.strategy_||new it;this.backoff_=t?t(e):new at(e),this.backoff_.on("ready",this.doCall_.bind(this,!0)),this.backoff_.on("fail",this.doCallback_.bind(this)),this.backoff_.on("backoff",this.handleBackoff_.bind(this)),this.failAfter_>0&&this.backoff_.failAfter(this.failAfter_),this.state_=r.State_.RUNNING,this.doCall_(!1)};r.prototype.doCall_=function(t){t&&this.numRetries_++;var e=["call"].concat(this.arguments_);b.EventEmitter.prototype.emit.apply(this,e);var a=this.handleFunctionCallback_.bind(this);this.function_.apply(null,this.arguments_.concat(a))};r.prototype.doCallback_=function(){this.callback_.apply(null,this.lastResult_)};r.prototype.handleFunctionCallback_=function(){if(!this.isAborted()){var t=Array.prototype.slice.call(arguments);this.lastResult_=t,b.EventEmitter.prototype.emit.apply(this,["callback"].concat(t));var e=t[0];e&&this.retryPredicate_(e)?this.backoff_.backoff(e):(this.state_=r.State_.COMPLETED,this.doCallback_())}};r.prototype.handleBackoff_=function(t,e,a){this.emit("backoff",t,e,a)};z.exports=r});var nt=o((kt,c)=>{var I=x(),J=G(),K=v(),Q=H();c.exports.Backoff=I;c.exports.FunctionCall=Q;c.exports.FibonacciStrategy=K;c.exports.ExponentialStrategy=J;c.exports.fibonacci=function(t){return new I(new K(t))};c.exports.exponential=function(t){return new I(new J(t))};c.exports.call=function(t,e,a){var n=Array.prototype.slice.call(arguments);return t=n[0],e=n.slice(1,n.length-1),a=n[n.length-1],new Q(t,e,a)}});export{nt as a};
